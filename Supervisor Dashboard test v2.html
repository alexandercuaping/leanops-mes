<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LeanOps ‚Äî Supervisor Dashboard v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --bg-panel: #020617;
      --bg-panel-soft: #0b1220;
      --bg-chip: #020617;
      --border-subtle: rgba(148, 163, 184, 0.35);
      --border-strong: rgba(148, 163, 184, 0.7);

      --accent: #f97316;
      --accent-soft: rgba(249, 115, 22, 0.12);
      --accent-strong: #ea580c;

      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --text-softer: #6b7280;

      --ok: #22c55e;
      --warn: #facc15;
      --danger: #f97316;
      --idle: #64748b;

      --radius-lg: 20px;
      --radius-md: 14px;
      --radius-pill: 999px;

      --font-main: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      --font-display: "Georgia", "Times New Roman", serif;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: var(--font-main);
      background: radial-gradient(circle at top left, #0b1120, #020617 55%, #020617 100%);
      color: var(--text-main);
    }

    body.light {
      background: #f5f5f7;
      color: #0f172a;
    }

    /* ---------- Layout shell ---------- */

    .sd-shell {
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      min-height: 100vh;
    }

    /* Collapsed sidebar (desktop) */
    .sd-shell.sidebar-collapsed {
      grid-template-columns: 0 minmax(0, 1fr);
    }


    @media (max-width: 920px) {
      .sd-shell {
        grid-template-columns: minmax(0, 1fr);
      }
      .sd-sidebar {
        position: sticky;
        top: 0;
        z-index: 30;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 12px 16px;
        gap: 14px;
      }
      .sd-sidebar-main,
      .sd-sidebar-filters {
        display: none;
      }
      .sd-sidebar.open .sd-sidebar-main,
      .sd-sidebar.open .sd-sidebar-filters {
        display: block;
      }
      .sd-sidebar.open {
        align-items: flex-start;
        flex-direction: column;
      }
    }

    /* ---------- Sidebar ---------- */

    .sd-sidebar {
      background: radial-gradient(circle at top left, #020617, #020617 55%);
      border-right: 1px solid rgba(15, 23, 42, 0.9);
      padding: 20px 18px;
      display: flex;
      flex-direction: column;
      gap: 18px;
      transition: transform 0.25s ease, opacity 0.2s ease;
    }

    /* When shell is collapsed, slide sidebar out and disable pointer events */
    .sd-shell.sidebar-collapsed .sd-sidebar {
      opacity: 0;
      transform: translateX(-24px);
      pointer-events: none;
    }

    body.light .sd-sidebar {
      background: #ffffff;
      border-right: 1px solid #e5e7eb;
    }

    .sd-logo {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding-left: 48px; /* <-- add this */
    }


    .sd-logo-mark {
      font-size: 15px;
      letter-spacing: 0.32em;
      text-transform: uppercase;
      font-weight: 800;
      color: #f9fafb;
    }

    .sd-logo-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    body.light .sd-logo-mark {
      color: #020617;
    }

    body.light .sd-sidebar-toggle {
      background: #f9fafb;
      color: #0f172a;
    }

    .sd-sidebar-main {
      margin-top: 6px;
    }

    .sd-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 13px;
    }

    .sd-nav button {
      border: none;
      background: transparent;
      text-align: left;
      padding: 8px 10px;
      border-radius: var(--radius-pill);
      color: var(--text-muted);
      cursor: pointer;
    }

    .sd-nav button.sd-nav-active {
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.9);
    }

    body.light .sd-nav button.sd-nav-active {
      background: #0f172a;
      color: #f9fafb;
    }

    .sd-sidebar-filters {
      margin-top: 18px;
      padding-top: 14px;
      border-top: 1px solid rgba(30, 64, 175, 0.6);
    }

    body.light .sd-sidebar-filters {
      border-top: 1px solid #e5e7eb;
    }

    .sd-filter-group {
      margin-bottom: 12px;
    }

    .sd-filter-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .sd-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .sd-chip {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 4px 10px;
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-chip);
      cursor: pointer;
    }

    .sd-chip.sd-chip-active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #fed7aa;
    }

    body.light .sd-chip {
      background: #f3f4f6;
      color: #4b5563;
    }

    body.light .sd-chip.sd-chip-active {
      background: #f97316;
      color: #111827;
      border-color: #ea580c;
    }

    .sd-theme-toggle {
      margin-top: auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
    }

.sd-hamburger {
  position: fixed;
  top: 18px;  /* was 14px */
  left: 14px;
  z-index: 50;
  width: 34px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-pill);
  border: 1px solid rgba(148, 163, 184, 0.6);
  background: rgba(15, 23, 42, 0.85);
  color: #e5e7eb;
  cursor: pointer;
  font-size: 16px;
}

body.light .sd-hamburger {
  background: #f9fafb;
  color: #0f172a;
}

    .sd-switch {
      width: 42px;
      height: 22px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 2px;
      display: flex;
      align-items: center;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.9);
    }

    .sd-switch-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #e5e7eb;
      transform: translateX(0);
      transition: transform 0.2s ease;
    }

    body.light .sd-switch {
      background: #e5e7eb;
    }

    body.light .sd-switch-thumb {
      transform: translateX(18px);
    }

    /* ---------- Main area ---------- */

    .sd-main {
      padding: 18px 22px 32px;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 720px) {
      .sd-main {
        padding-inline: 14px;
      }
    }

    .sd-top-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 14px;
      align-items: center;
      margin-bottom: 14px;
    }

    .sd-top-title {
      font-family: var(--font-display);
      font-size: 22px;
      letter-spacing: 0.02em;
    }

    .sd-top-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .sd-top-meta-wrap {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .sd-main-filter-toggle {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(148, 163, 184, 0.75);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    body.light .sd-main-filter-toggle {
      background: #ffffff;
      color: #4b5563;
    }

    /* Hide desktop toggle on small screens (we already have the mobile Filters button) */
    @media (max-width: 920px) {
      .sd-main-filter-toggle {
        display: none;
      }
    }

    .sd-today-summary {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }

    @media (max-width: 920px) {
      .sd-today-summary {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 580px) {
      .sd-today-summary {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .sd-summary-card {
      border-radius: 16px;
      padding: 10px 12px;
      background: radial-gradient(circle at top left, #0b1120, #020617);
      border: 1px solid rgba(148, 163, 184, 0.45);
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.6);
      font-size: 12px;
    }

    body.light .sd-summary-card {
      background: #ffffff;
      box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
    }

    .sd-summary-label {
      text-transform: uppercase;
      letter-spacing: 0.14em;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .sd-summary-value {
      font-size: 18px;
      font-weight: 600;
    }

    .sd-summary-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .sd-priority-strip {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0 18px;
    }

    .sd-priority-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(248, 250, 252, 0.06);
      color: var(--text-muted);
      cursor: pointer;
    }

    .sd-priority-pill span.sd-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--danger);
    }

    .sd-priority-pill.sd-pill-warn span.sd-dot { background: var(--warn); }
    .sd-priority-pill.sd-pill-ok span.sd-dot { background: var(--ok); }

    body.light .sd-priority-pill {
      background: #ffffff;
      border-color: #e5e7eb;
      color: #4b5563;
    }

    .sd-view-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      font-size: 12px;
    }

    .sd-view-toggle {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.85);
    }

    .sd-view-toggle button {
      border: none;
      background: transparent;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
    }

    .sd-view-toggle button.sd-view-active {
      background: #f97316;
      color: #111827;
      font-weight: 600;
    }

    body.light .sd-view-toggle {
      background: #f3f4f6;
    }

    .sd-inline-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .sd-inline-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      padding: 5px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    body.light .sd-inline-btn {
      background: #ffffff;
      color: #4b5563;
    }

    /* ---------- Station grid & cards ---------- */

    .sd-stations {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 1000px) {
      .sd-stations {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .sd-station-card {
      position: relative;
      z-index: 0; /* baseline, so active card can sit above others */
      border-radius: var(--radius-lg);
      background: linear-gradient(145deg, #020617, #020617 35%, #020617 100%);
      border: 1px solid rgba(15, 23, 42, 0.9);
      box-shadow:
        0 16px 36px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(148, 163, 184, 0.22);
      padding: 12px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: pointer;
      transition: transform 0.16s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }

    /* When a card's More-actions menu is open, float it above neighbors */
    .sd-station-card.sd-card-active {
      z-index: 100;
    }


    .sd-station-card:hover {
      transform: translateY(-3px);
      box-shadow:
        0 22px 46px rgba(15, 23, 42, 0.95),
        0 0 0 1px rgba(248, 250, 252, 0.08);
      border-color: rgba(248, 250, 252, 0.12);
    }

    body.light .sd-station-card {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12);
    }

    .sd-station-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .sd-station-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .sd-station-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .sd-status-pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-muted);
    }

    .sd-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--idle);
    }

    .sd-status-running .sd-status-dot { background: var(--ok); }
    .sd-status-waiting .sd-status-dot { background: var(--warn); }
    .sd-status-blocked .sd-status-dot { background: var(--danger); }
    .sd-status-idle .sd-status-dot { background: var(--idle); }

    body.light .sd-status-pill {
      background: #f9fafb;
      color: #4b5563;
    }

    .sd-station-main {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 1.6fr);
      gap: 10px;
      font-size: 12px;
    }

    @media (max-width: 680px) {
      .sd-station-main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .sd-job-meta-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 3px;
    }

    .sd-job-label {
      color: var(--text-muted);
    }

    .sd-job-value {
      font-weight: 500;
    }

    .sd-progress-wrap {
      margin-top: 4px;
    }

    .sd-progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .sd-progress-bar {
      position: relative;
      height: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }

    .sd-progress-fill {
      position: absolute;
      inset: 0;
      width: 40%;
      border-radius: inherit;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.25s ease;
    }

    body.light .sd-progress-bar {
      background: #e5e7eb;
    }

    /* --- Next job preview inside station card --- */
    .sd-next-job {
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px dashed rgba(148, 163, 184, 0.6);
    }

    body.light .sd-next-job {
      background: #f3f4f6;
      border-style: solid;
    }

    .sd-next-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .sd-next-main {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-size: 11px;
    }

    .sd-next-id {
      font-weight: 600;
    }

    .sd-next-meta {
      color: var(--text-muted);
      text-align: right;
      white-space: nowrap;
    }

    .sd-metrics {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 8px 9px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    body.light .sd-metrics {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .sd-metric-label {
      color: var(--text-muted);
    }

    .sd-metric-value {
      font-weight: 600;
      font-size: 12px;
    }

    .sd-station-actions {
      margin-top: 4px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 11px;
    }

    .sd-action-chip {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.75);
      padding: 5px 9px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.16s ease,
        border-color 0.16s ease,
        color 0.16s ease,
        transform 0.12s ease;
    }

    /* Hover state for action chips (dark mode) */
    .sd-action-chip:hover {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #fef3c7;
      transform: translateY(-1px);
    }

    body.light .sd-action-chip {
      background: #ffffff;
      color: #4b5563;
    }

    /* Hover state for action chips (light mode) */
    body.light .sd-action-chip:hover {
      background: #f97316;
      border-color: #ea580c;
      color: #111827;
    }

        /* --- Per-station queue summary --- */
    .sd-queue {
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      font-size: 11px;
    }

    .sd-queue-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .sd-queue-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .sd-queue-pill {
      border-radius: 999px;
      padding: 4px 8px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.85);
      color: var(--text-muted);
      cursor: pointer;
      transition: border-color 0.16s ease, color 0.16s ease, background 0.16s ease;
    }

    .sd-queue-pill:hover {
      border-color: var(--accent);
      color: #fef3c7;
      background: rgba(15, 23, 42, 0.95);
    }

    .sd-queue-pill.sd-queue-pill-active {
      border-color: var(--accent);
      color: #fef3c7;
      background: var(--accent-soft);
    }

    body.light .sd-queue-pill {
      background: #f9fafb;
      color: #4b5563;
      border-color: #e5e7eb;
    }

    body.light .sd-queue-pill:hover,
    body.light .sd-queue-pill.sd-queue-pill-active {
      background: #f97316;
      border-color: #ea580c;
      color: #111827;
    }

    /* --- Job move mini-menu inside each card --- */
    .sd-job-move-menu {
      position: absolute;
      right: 16px;
      bottom: 14px;
      display: none;
      flex-direction: column;
      gap: 4px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(148, 163, 184, 0.85);
      box-shadow: 0 14px 40px rgba(15, 23, 42, 0.9);
      z-index: 5;
      font-size: 11px;
    }

    .sd-job-move-menu button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      text-align: left;
      padding: 4px 6px;
      border-radius: 8px;
      cursor: pointer;
    }

    .sd-job-move-menu button:hover {
      background: rgba(15, 23, 42, 0.9);
      color: #fef3c7;
    }

    body.light .sd-job-move-menu {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 10px 28px rgba(15, 23, 42, 0.18);
    }

    body.light .sd-job-move-menu button:hover {
      background: #f3f4f6;
      color: #111827;
    }

    .sd-station-card.sd-job-move-open .sd-job-move-menu {
      display: flex;
    }

    /* --- "More actions" dropdown --- */
    .sd-more-wrapper {
      position: relative;
    }

    .sd-more-toggle {
      min-width: 110px;
      justify-content: center;
    }

    .sd-more-menu {
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 6px;
      padding: 6px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.9);
      display: none;
      flex-direction: column;
      gap: 4px;
      z-index: 60;
    }

    .sd-more-wrapper.open .sd-more-menu {
      display: flex;
    }

    .sd-more-menu .sd-action-chip {
      width: 100%;
      justify-content: flex-start;
    }

    /* Light mode dropdown look */
    body.light .sd-more-menu {
      background: #ffffff;
      border-color: #e5e7eb;
      box-shadow: 0 12px 28px rgba(15, 23, 42, 0.16);
    }

    /* Compact view */
    .view-compact .sd-station-main {
      grid-template-columns: minmax(0, 1fr);
    }

    .view-compact .sd-metrics {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    /* ---------- Action drawer ---------- */

    /* Light-mode styling for the status dropdown */
    body.light #statusSelect {
      background: #ffffff !important;
      color: #111827 !important;
      border-color: #d1d5db !important;
    }
    
    .sd-drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: none;
      align-items: stretch;
      justify-content: flex-end;
      z-index: 40;
    }

    .sd-drawer-backdrop.open {
      display: flex;
    }

    .sd-drawer {
      width: 360px;
      max-width: 100%;
      background: radial-gradient(circle at top left, #020617, #020617 75%);
      border-left: 1px solid rgba(148, 163, 184, 0.55);
      box-shadow: -18px 0 38px rgba(15, 23, 42, 0.9);
      padding: 18px 18px 22px;
    }

    body.light .sd-drawer {
      background: #ffffff;
      border-left: 1px solid #e5e7eb;
      box-shadow: -14px 0 34px rgba(15, 23, 42, 0.16);
    }

    .sd-drawer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .sd-drawer-title {
      font-family: var(--font-display);
      font-size: 18px;
    }

    .sd-drawer-close {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      padding: 4px 9px;
      font-size: 12px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
    }

    .sd-drawer-section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--text-muted);
      margin-top: 14px;
      margin-bottom: 4px;
    }

    .sd-drawer-box {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      padding: 10px 11px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }

    body.light .sd-drawer-box {
      background: #f9fafb;
      border-color: #e5e7eb;
    }

    .sd-drawer-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .sd-drawer-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text-main);
      padding: 7px 12px;
      font-size: 12px;
      cursor: pointer;
    }

    .sd-drawer-btn.sd-primary {
      border-color: transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent-strong));
      color: #111827;
      font-weight: 600;
    }

    body.light .sd-drawer-btn {
      background: #111827;
      color: #f9fafb;
    }

    body.light .sd-drawer-btn.sd-primary {
      background: linear-gradient(135deg, #f97316, #ea580c);
    }

  </style>
</head>

<body class="dark">
  <button class="sd-hamburger" id="toggleSidebarGlobal">‚ò∞</button>
  <div class="sd-shell">
    <!-- SIDEBAR -->
    <aside class="sd-sidebar">
      <div class="sd-logo">
  <div>
    <div class="sd-logo-mark">LEANOPS</div>
    <div class="sd-logo-sub">Supervisor ‚Äî Live Stations</div>
  </div>
</div>

      <div class="sd-sidebar-main">
        <nav class="sd-nav">
          <button class="sd-nav-active">Live stations</button>
          <button disabled title="Coming soon">Job queue (coming soon)</button>
          <button disabled title="Coming soon">Analytics (coming soon)</button>
        </nav>
      </div>

      <div class="sd-sidebar-filters">
        <div class="sd-filter-group">
          <div class="sd-filter-label">View</div>
          <div class="sd-chip-row">
            <button class="sd-chip sd-chip-active" data-view="expanded">Expanded</button>
            <button class="sd-chip" data-view="compact">Compact</button>
          </div>
        </div>

        <div class="sd-filter-group">
          <div class="sd-filter-label">Status</div>
          <div class="sd-chip-row">
            <button class="sd-chip sd-chip-active" data-status="all">All</button>
            <button class="sd-chip" data-status="running">Running</button>
            <button class="sd-chip" data-status="waiting">Waiting</button>
            <button class="sd-chip" data-status="blocked">Blocked</button>
          </div>
        </div>

        <div class="sd-filter-group">
          <div class="sd-filter-label">Line</div>
          <div class="sd-chip-row">
            <button class="sd-chip sd-chip-active" data-line="all">All lines</button>
            <button class="sd-chip" data-line="A">Line A</button>
            <button class="sd-chip" data-line="B">Line B</button>
          </div>
        </div>
      </div>

      <div class="sd-theme-toggle">
        <span>Theme</span>
        <div class="sd-switch" id="themeToggle">
          <div class="sd-switch-thumb"></div>
        </div>
      </div>
    </aside>

    <!-- MAIN AREA -->
    <main class="sd-main">
      <div class="sd-top-row">
        <div>
          <div class="sd-top-title">Today‚Äôs flow</div>
          <div class="sd-top-meta">Lightweight MES view for jobs, stations, and flow.</div>
        </div>
        <div class="sd-top-meta" id="sd-date"></div>
      </div>

      <!-- TODAY SUMMARY -->
      <section class="sd-today-summary">
        <article class="sd-summary-card">
          <div class="sd-summary-label">Jobs completed</div>
          <div class="sd-summary-value" id="summaryCompleted">7</div>
          <div class="sd-summary-sub">Batches logged today (demo)</div>
        </article>
        <article class="sd-summary-card">
          <div class="sd-summary-label">On-time completion</div>
          <div class="sd-summary-value" id="summaryOnTime">92%</div>
          <div class="sd-summary-sub">Based on current schedule</div>
        </article>
        <article class="sd-summary-card">
          <div class="sd-summary-label">Stations running</div>
          <div class="sd-summary-value" id="summaryRunning">3 / 8</div>
          <div class="sd-summary-sub">Actively marked as running</div>
        </article>
        <article class="sd-summary-card">
          <div class="sd-summary-label">Material flags</div>
          <div class="sd-summary-value" id="summaryMaterial">2</div>
          <div class="sd-summary-sub">Stations waiting on material</div>
        </article>
      </section>

      <!-- PRIORITY STRIP -->
      <div class="sd-priority-strip">
        <button class="sd-priority-pill" data-status-filter="blocked">
          <span class="sd-dot"></span>
          <span>1 station blocked</span>
        </button>
        <button class="sd-priority-pill sd-pill-warn" data-status-filter="waiting">
          <span class="sd-dot"></span>
          <span>2 waiting on material</span>
        </button>
        <button class="sd-priority-pill sd-pill-ok" data-status-filter="running">
          <span class="sd-dot"></span>
          <span>3 running at or above pace</span>
        </button>
      </div>

      <!-- VIEW CONTROLS -->
      <div class="sd-view-row">
        <div class="sd-view-toggle">
          <button class="sd-view-active" data-view-main="expanded">Expanded</button>
          <button data-view-main="compact">Compact</button>
        </div>
        <div class="sd-inline-actions">
          <button class="sd-inline-btn">Quick refresh</button>
          <button class="sd-inline-btn">Global job queue</button>
          <button class="sd-inline-btn">Simulate next hour</button>
        </div>
      </div>

      <!-- STATION GRID -->
      <section id="stationsGrid" class="sd-stations view-expanded">
        <!-- Example station cards (these will later be driven by data) -->
        <article class="sd-station-card sd-status-running"
                 data-status="running" data-line="A" data-station="ST-01">
          <div class="sd-station-header">
            <div>
              <div class="sd-station-title">Station 1 ‚Äî Panel Assembly</div>
              <div class="sd-station-sub">Line A ¬∑ ST-01</div>
            </div>
            <div class="sd-status-pill">
              <span class="sd-status-dot"></span>
              <span>Running</span>
            </div>
          </div>

          <div class="sd-station-main">
            <div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Current job</div>
                <div class="sd-job-value">JOB-1001</div>
              </div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Description</div>
                <div class="sd-job-value">Panel Assembly</div>
              </div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Due</div>
                <div class="sd-job-value">Nov 30</div>
              </div>

              <div class="sd-progress-wrap">
                <div class="sd-progress-label">
                  <span>Progress</span>
                  <span>40 / 50 pcs</span>
                </div>
                <div class="sd-progress-bar">
                  <div class="sd-progress-fill" style="width:80%"></div>
                </div>
              </div>

              <div class="sd-next-job">
                <div class="sd-next-label">Next job</div>
                <div class="sd-next-main">
                  <span class="sd-next-id">JOB-1008</span>
                  <span class="sd-next-meta">20 pcs ¬∑ Due Dec 1</span>
                </div>
              </div>
            </div>

            <div class="sd-metrics">

              <div>
                <div class="sd-metric-label">Pace vs std</div>
                <div class="sd-metric-value">104%</div>
              </div>
              <div>
                <div class="sd-metric-label">Units this hour</div>
                <div class="sd-metric-value">12</div>
              </div>
              <div>
                <div class="sd-metric-label">Material OK</div>
                <div class="sd-metric-value">Yes</div>
              </div>
            </div>
          </div>

          <div class="sd-station-actions">
            <!-- Primary actions (always visible) -->
            <span class="sd-action-chip">‚úî Mark complete</span>
            <span class="sd-action-chip">üì¶ Request material</span>
            <span class="sd-action-chip">üîÑ Change status</span>

            <!-- More actions dropdown -->
            <div class="sd-more-wrapper">
              <span class="sd-action-chip sd-more-toggle">‚ãØ More actions</span>
              <div class="sd-more-menu">
                <button class="sd-action-chip sd-more-item">‚Ü™ Move to next station</button>
                <button class="sd-action-chip sd-more-item">‚ö† Flag issue</button>
                <button class="sd-action-chip sd-more-item">üõ† Open issue</button>
                <button class="sd-action-chip sd-more-item">üëÄ Request supervisor</button>
                <button class="sd-action-chip sd-more-item">‚Ü™ Reassign job</button>
                <button class="sd-action-chip sd-more-item">üìù Add note</button>
                <button class="sd-action-chip sd-more-item">‚ö† Escalate</button>
              </div>
            </div>
          </div>

          <div class="sd-queue">
            <div class="sd-queue-title">Queue</div>
            <div class="sd-queue-list">
              <span class="sd-queue-pill">JOB-1015 ¬∑ 30 pcs ¬∑ Today</span>
              <span class="sd-queue-pill">JOB-1020 ¬∑ 10 pcs ¬∑ Tomorrow</span>
            </div>
          </div>

          <!-- Job move menu -->
          <div class="sd-job-move-menu">
            <button type="button" data-move-target="current">Move job to current</button>
            <button type="button" data-move-target="next">Move job to next</button>
            <button type="button" data-move-target="queue">Move job to queue</button>
          </div>
        </article>


        <article class="sd-station-card sd-status-waiting"
                 data-status="waiting" data-line="A" data-station="ST-02">
          <div class="sd-station-header">
            <div>
              <div class="sd-station-title">Station 2 ‚Äî Frame Assembly</div>
              <div class="sd-station-sub">Line A ¬∑ ST-02</div>
            </div>
            <div class="sd-status-pill">
              <span class="sd-status-dot"></span>
              <span>Waiting material</span>
            </div>
          </div>

          <div class="sd-station-main">
            <div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Current job</div>
                <div class="sd-job-value">JOB-1005</div>
              </div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Description</div>
                <div class="sd-job-value">Frame Assembly</div>
              </div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Due</div>
                <div class="sd-job-value">Nov 29</div>
              </div>

              <div class="sd-progress-wrap">
                <div class="sd-progress-label">
                  <span>Progress</span>
                  <span>18 / 40 pcs</span>
                </div>
                <div class="sd-progress-bar">
                  <div class="sd-progress-fill" style="width:45%"></div>
                </div>
              </div>

              <div class="sd-next-job">
                <div class="sd-next-label">Next job</div>
                <div class="sd-next-main">
                  <span class="sd-next-id">JOB-1010</span>
                  <span class="sd-next-meta">22 pcs ¬∑ Due Dec 2</span>
                </div>
              </div>
            </div>

            <div class="sd-metrics">

              <div>
                <div class="sd-metric-label">Pace vs std</div>
                <div class="sd-metric-value">88%</div>
              </div>
              <div>
                <div class="sd-metric-label">Units this hour</div>
                <div class="sd-metric-value">4</div>
              </div>
              <div>
                <div class="sd-metric-label">Material OK</div>
                <div class="sd-metric-value">No</div>
              </div>
            </div>
          </div>

          <div class="sd-station-actions">
            <!-- Primary actions (always visible) -->
            <span class="sd-action-chip">‚úî Mark complete</span>
            <span class="sd-action-chip">üì¶ Request material</span>
            <span class="sd-action-chip">üîÑ Change status</span>

            <!-- More actions dropdown -->
            <div class="sd-more-wrapper">
              <span class="sd-action-chip sd-more-toggle">‚ãØ More actions</span>
              <div class="sd-more-menu">
                <button class="sd-action-chip sd-more-item">‚Ü™ Move to next station</button>
                <button class="sd-action-chip sd-more-item">‚ö† Flag issue</button>
                <button class="sd-action-chip sd-more-item">üõ† Open issue</button>
                <button class="sd-action-chip sd-more-item">üëÄ Request supervisor</button>
                <button class="sd-action-chip sd-more-item">‚Ü™ Reassign job</button>
                <button class="sd-action-chip sd-more-item">üìù Add note</button>
                <button class="sd-action-chip sd-more-item">‚ö† Escalate</button>
              </div>
            </div>
          </div>

          <div class="sd-queue">
            <div class="sd-queue-title">Queue</div>
            <div class="sd-queue-list">
              <span class="sd-queue-pill">JOB-1022 ¬∑ 16 pcs ¬∑ Today</span>
              <span class="sd-queue-pill">JOB-1027 ¬∑ 12 pcs ¬∑ Tomorrow</span>
            </div>
          </div>

          <!-- Job move menu -->
          <div class="sd-job-move-menu">
            <button type="button" data-move-target="current">Move job to current</button>
            <button type="button" data-move-target="next">Move job to next</button>
            <button type="button" data-move-target="queue">Move job to queue</button>
          </div>
        </article>


        <article class="sd-station-card sd-status-blocked"
                 data-status="blocked" data-line="B" data-station="ST-03">
          <div class="sd-station-header">
            <div>
              <div class="sd-station-title">Station 3 ‚Äî Final Inspection</div>
              <div class="sd-station-sub">Line B ¬∑ ST-03</div>
            </div>
            <div class="sd-status-pill">
              <span class="sd-status-dot"></span>
              <span>Blocked</span>
            </div>
          </div>

          <div class="sd-station-main">
            <div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Current job</div>
                <div class="sd-job-value">JOB-1012</div>
              </div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Description</div>
                <div class="sd-job-value">QC & Pack</div>
              </div>
              <div class="sd-job-meta-row">
                <div class="sd-job-label">Due</div>
                <div class="sd-job-value">Today</div>
              </div>

              <div class="sd-progress-wrap">
                <div class="sd-progress-label">
                  <span>Progress</span>
                  <span>6 / 20 pcs</span>
                </div>
                <div class="sd-progress-bar">
                  <div class="sd-progress-fill" style="width:30%"></div>
                </div>
              </div>

              <div class="sd-next-job">
                <div class="sd-next-label">Next job</div>
                <div class="sd-next-main">
                  <span class="sd-next-id">JOB-1018</span>
                  <span class="sd-next-meta">15 pcs ¬∑ Due Dec 1</span>
                </div>
              </div>
            </div>

            <div class="sd-metrics">

              <div>
                <div class="sd-metric-label">Issue</div>
                <div class="sd-metric-value">Rework</div>
              </div>
              <div>
                <div class="sd-metric-label">Time blocked</div>
                <div class="sd-metric-value">32 min</div>
              </div>
              <div>
                <div class="sd-metric-label">Support</div>
                <div class="sd-metric-value">Requested</div>
              </div>
            </div>
          </div>

          <div class="sd-station-actions">
            <!-- Primary actions (always visible) -->
            <span class="sd-action-chip">‚úî Mark complete</span>
            <span class="sd-action-chip">üì¶ Request material</span>
            <span class="sd-action-chip">üîÑ Change status</span>

            <!-- More actions dropdown -->
            <div class="sd-more-wrapper">
              <span class="sd-action-chip sd-more-toggle">‚ãØ More actions</span>
              <div class="sd-more-menu">
                <button class="sd-action-chip sd-more-item">‚Ü™ Move to next station</button>
                <button class="sd-action-chip sd-more-item">‚ö† Flag issue</button>
                <button class="sd-action-chip sd-more-item">üõ† Open issue</button>
                <button class="sd-action-chip sd-more-item">üëÄ Request supervisor</button>
                <button class="sd-action-chip sd-more-item">‚Ü™ Reassign job</button>
                <button class="sd-action-chip sd-more-item">üìù Add note</button>
                <button class="sd-action-chip sd-more-item">‚ö† Escalate</button>
              </div>
            </div>
          </div>

          <div class="sd-queue">
            <div class="sd-queue-title">Queue</div>
            <div class="sd-queue-list">
              <span class="sd-queue-pill">JOB-1030 ¬∑ 8 pcs ¬∑ Today</span>
              <span class="sd-queue-pill">JOB-1034 ¬∑ 18 pcs ¬∑ Tomorrow</span>
            </div>
          </div>

          <!-- Job move menu -->
          <div class="sd-job-move-menu">
            <button type="button" data-move-target="current">Move job to current</button>
            <button type="button" data-move-target="next">Move job to next</button>
            <button type="button" data-move-target="queue">Move job to queue</button>
          </div>
        </article>


        <!-- Add more demo stations or generate via JS once wired to Supabase -->
      </section>
    </main>
  </div>

  <!-- ACTION DRAWER -->
  <div class="sd-drawer-backdrop" id="drawerBackdrop">
    <div class="sd-drawer">
      <div class="sd-drawer-header">
        <div>
          <div class="sd-drawer-title" id="drawerTitle">Station details</div>
          <div class="sd-top-meta" id="drawerSubtitle">Line ¬∑ Station ¬∑ Current job</div>
        </div>
        <button class="sd-drawer-close" id="drawerClose">Close</button>
      </div>

      <div>
        <div class="sd-drawer-section-label">Snapshot</div>
        <div class="sd-drawer-box" id="drawerSnapshot">
          Select a station to see live details.
        </div>

        <div class="sd-drawer-section-label">Status</div>
        <div class="sd-drawer-box">
          <select id="statusSelect" style="
              width: 100%;
              padding: 6px;
              border-radius: 8px;
              background: #0f172a;
              color: #e5e7eb;
              border: 1px solid rgba(148,163,184,0.6);
            ">
            <option value="running">Running</option>
            <option value="waiting">Waiting</option>
            <option value="blocked">Blocked</option>
            <option value="idle">Idle</option>
          </select>
        </div>


        <div class="sd-drawer-section-label">Quick actions</div>
        <div class="sd-drawer-actions">
          <button class="sd-drawer-btn sd-primary">Mark job complete</button>
          <button class="sd-drawer-btn">Request material</button>
          <button class="sd-drawer-btn">Move to next station</button>
          <button class="sd-drawer-btn">Log issue</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Date label ---
    const dateEl = document.getElementById('sd-date');
    const now = new Date();
    dateEl.textContent = now.toLocaleDateString(undefined, {
      weekday: 'short',
      month: 'short',
      day: 'numeric'
    });

    // --- Theme toggle ---
    const themeToggle = document.getElementById('themeToggle');
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('light');
    });

    // --- Sidebar toggle (hamburger) ---
    const shell = document.querySelector('.sd-shell');
    const sidebar = document.querySelector('.sd-sidebar');
    const toggleSidebarGlobal = document.getElementById('toggleSidebarGlobal');

    toggleSidebarGlobal.addEventListener('click', () => {
      if (window.innerWidth <= 920) {
        sidebar.classList.toggle('open');
      } else {
        shell.classList.toggle('sidebar-collapsed');
      }
    });


    // --- View toggle (compact / expanded) ---
    const stationsGrid = document.getElementById('stationsGrid');
    document.querySelectorAll('[data-view-main]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-view-main]').forEach(b => b.classList.remove('sd-view-active'));
        btn.classList.add('sd-view-active');

        const view = btn.getAttribute('data-view-main');
        stationsGrid.classList.toggle('view-compact', view === 'compact');
      });
    });

    // Sidebar view chips keep in sync
    document.querySelectorAll('.sd-chip[data-view]').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.sd-chip[data-view]').forEach(c => c.classList.remove('sd-chip-active'));
        chip.classList.add('sd-chip-active');

        const view = chip.getAttribute('data-view');
        const mainBtn = document.querySelector(`[data-view-main="${view}"]`);
        mainBtn?.click();
      });
    });

    // --- Status + line filtering ---
    function applyFilters() {
      const activeStatusChip = document.querySelector('.sd-chip[data-status].sd-chip-active');
      const activeLineChip = document.querySelector('.sd-chip[data-line].sd-chip-active');
      const statusFilter = activeStatusChip?.getAttribute('data-status') || 'all';
      const lineFilter = activeLineChip?.getAttribute('data-line') || 'all';

      document.querySelectorAll('.sd-station-card').forEach(card => {
        const s = card.getAttribute('data-status');
        const l = card.getAttribute('data-line');
        const statusMatch = statusFilter === 'all' || s === statusFilter;
        const lineMatch = lineFilter === 'all' || l === lineFilter;
        card.style.display = statusMatch && lineMatch ? '' : 'none';
      });
    }

    document.querySelectorAll('.sd-chip[data-status]').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.sd-chip[data-status]').forEach(c => c.classList.remove('sd-chip-active'));
        chip.classList.add('sd-chip-active');
        applyFilters();
      });
    });

    document.querySelectorAll('.sd-chip[data-line]').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.sd-chip[data-line]').forEach(c => c.classList.remove('sd-chip-active'));
        chip.classList.add('sd-chip-active');
        applyFilters();
      });
    });

    // Priority strip shortcuts
    document.querySelectorAll('.sd-priority-pill').forEach(pill => {
      pill.addEventListener('click', () => {
        const status = pill.getAttribute('data-status-filter');
        if (!status) return;
        const chip = document.querySelector(`.sd-chip[data-status="${status}"]`);
        chip?.click();
      });
    });

    // --- Action drawer ---
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const drawerClose = document.getElementById('drawerClose');
    const drawerTitle = document.getElementById('drawerTitle');
    const drawerSubtitle = document.getElementById('drawerSubtitle');
    const drawerSnapshot = document.getElementById('drawerSnapshot');

    function openDrawerFromCard(card) {
      const stationTitle = card.querySelector('.sd-station-title')?.textContent.trim() || 'Station';
      const stationSub = card.querySelector('.sd-station-sub')?.textContent.trim() || '';
      const jobId = card.querySelector('.sd-job-value')?.textContent.trim() || 'N/A';
      const progressLabel = card.querySelector('.sd-progress-label span:last-child')?.textContent.trim() || '';

      drawerTitle.textContent = stationTitle;
      drawerSubtitle.textContent = `${stationSub} ¬∑ ${jobId}`;

      drawerSnapshot.innerHTML = `
        <div><strong>Current job:</strong> ${jobId}</div>
        <div><strong>Progress:</strong> ${progressLabel}</div>
        <div style="margin-top:6px; font-size:11px; color:#9ca3af;">
          (Later this will show live metrics from your data source: pace vs standard, 
          last update timestamp, and any open issues.)
        </div>
      `;

      drawerBackdrop.classList.add('open');
    }

    document.querySelectorAll('.sd-station-card').forEach(card => {
      card.addEventListener('click', (evt) => {
        // If the click came from an action chip, do NOT open the drawer
        if (evt.target.closest('.sd-action-chip')) {
          return;
        }

        // Otherwise, treat it as a card click and open the drawer
        openDrawerFromCard(card);
      });
    });

    // --- Inline station action chips (mark complete, request material, etc.) ---
    document.querySelectorAll('.sd-action-chip').forEach(chip => {
      chip.addEventListener('click', (evt) => {
        // Prevent the click from bubbling up to the card
        evt.stopPropagation();

        const actionText = chip.textContent.trim();
        const card = chip.closest('.sd-station-card');
        const stationTitle =
          card?.querySelector('.sd-station-title')?.textContent.trim() || 'Station';
        const jobId =
          card?.querySelector('.sd-job-value')?.textContent.trim() || 'N/A';

        // 1) "More actions" toggle
        if (chip.classList.contains('sd-more-toggle')) {
          const wrapper = chip.closest('.sd-more-wrapper');
          const isOpen = wrapper.classList.contains('open');

          // Close all menus first + drop any elevated cards
          document
            .querySelectorAll('.sd-more-wrapper')
            .forEach(w => w.classList.remove('open'));
          document
            .querySelectorAll('.sd-station-card')
            .forEach(c => c.classList.remove('sd-card-active'));

          if (!isOpen) {
            wrapper.classList.add('open');
            // lift this card above others so its menu isn't overlapped
            card.classList.add('sd-card-active');
          }
          return;
        }


        // If this click came from inside a dropdown menu, close that menu
        const wrapper = chip.closest('.sd-more-wrapper');
        if (wrapper) {
          wrapper.classList.remove('open');
        }

        // 2) "Change status" ‚Üí open drawer + focus status dropdown
        if (actionText.includes("Change status")) {
          openDrawerFromCard(card);

          const currentStatus = card.getAttribute('data-status') || 'running';
          const statusSelectEl = document.getElementById('statusSelect');
          statusSelectEl.value = currentStatus;
          statusSelectEl.focus();

          return; // Don't run generic logic
        }

        // 3) Default placeholder (later this will call Supabase, etc.)
        console.log(`Action clicked: ${actionText} on ${stationTitle} (${jobId})`);
        alert(`TODO: ${actionText} for ${stationTitle} (${jobId})`);
      });
    });

   // Close menus when clicking outside them
  document.addEventListener('click', (evt) => {
    const target = evt.target;

    // 1) Close "More actions" menus if click is outside them
    if (!target.closest('.sd-more-wrapper')) {
      document
        .querySelectorAll('.sd-more-wrapper.open')
        .forEach(w => w.classList.remove('open'));

      // also drop any elevated cards
      document
        .querySelectorAll('.sd-station-card.sd-card-active')
        .forEach(c => c.classList.remove('sd-card-active'));
    }

    // 2) Close job-move menu if click is outside ALL station cards
    if (!target.closest('.sd-station-card')) {
      document
        .querySelectorAll('.sd-station-card.sd-job-move-open')
        .forEach(card => closeJobMoveForCard(card));
    }
  });

    drawerClose.addEventListener('click', () => {
      drawerBackdrop.classList.remove('open');
    });

    drawerBackdrop.addEventListener('click', (e) => {
      if (e.target === drawerBackdrop) {
        drawerBackdrop.classList.remove('open');
      }
    });

    // Close drawer + menus with ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' || e.key === 'Esc') {
        // 1) Close the right-hand drawer
        drawerBackdrop.classList.remove('open');

        // 2) Close any open job-move menus
        document
          .querySelectorAll('.sd-station-card.sd-job-move-open')
          .forEach(card => closeJobMoveForCard(card));

        // 3) Close any open "More actions" menus
        document
          .querySelectorAll('.sd-more-wrapper.open')
          .forEach(w => w.classList.remove('open'));

        // 4) Remove elevation from any active cards
        document
          .querySelectorAll('.sd-station-card.sd-card-active')
          .forEach(card => card.classList.remove('sd-card-active'));
      }
    });

    // --- Status dropdown -> update card status ---
    const statusSelectEl = document.getElementById('statusSelect');

    statusSelectEl.addEventListener('change', function () {
      const newStatus = this.value;

      // Find the card currently shown in the drawer
      const title = drawerTitle.textContent.trim();
      const matchingCard = [...document.querySelectorAll('.sd-station-card')]
        .find(c => c.querySelector('.sd-station-title')?.textContent.trim() === title);

      if (!matchingCard) return;

      // Update data-status (so filters & logic use the new value)
      matchingCard.setAttribute('data-status', newStatus);

      // Remove old status classes
      matchingCard.classList.remove(
        'sd-status-running',
        'sd-status-waiting',
        'sd-status-blocked',
        'sd-status-idle'
      );

      // Add the new one
      matchingCard.classList.add(`sd-status-${newStatus}`);

      // Update pill label & dot color
      const pillLabel = matchingCard.querySelector('.sd-status-pill span:last-child');
      const dot = matchingCard.querySelector('.sd-status-dot');

      if (pillLabel) {
        pillLabel.textContent = newStatus.charAt(0).toUpperCase() + newStatus.slice(1);
      }

      if (dot) {
        if (newStatus === 'running') dot.style.background = 'var(--ok)';
        else if (newStatus === 'waiting') dot.style.background = 'var(--warn)';
        else if (newStatus === 'blocked') dot.style.background = 'var(--danger)';
        else dot.style.background = 'var(--idle)';
      }

      // Re-apply filters so this card may hide/show correctly based on new status
      applyFilters();
    });


    // --- Job move interactions (current / next / queue) ---

    function closeJobMoveForCard(card) {
      card.classList.remove('sd-job-move-open');
      delete card.dataset.pendingJobLabel;
      delete card.dataset.pendingJobSource;
      card.querySelectorAll('.sd-queue-pill-active').forEach(p => p.classList.remove('sd-queue-pill-active'));
    }

    function startJobMove(card, source, label) {
      if (!card || !label) return;
      card.dataset.pendingJobLabel = label;
      card.dataset.pendingJobSource = source;

      card.querySelectorAll('.sd-queue-pill-active').forEach(p => p.classList.remove('sd-queue-pill-active'));
      card.classList.add('sd-job-move-open');
    }

    function handleQueuePillClick(evt) {
      evt.stopPropagation();
      const pill = evt.currentTarget;
      const card = pill.closest('.sd-station-card');
      if (!card) return;

      card.querySelectorAll('.sd-queue-pill-active').forEach(p => p.classList.remove('sd-queue-pill-active'));
      pill.classList.add('sd-queue-pill-active');

      const label = pill.textContent.trim();
      startJobMove(card, 'queue', label);
    }

    function handleCurrentJobClick(evt) {
      evt.stopPropagation();
      const el = evt.currentTarget;
      const card = el.closest('.sd-station-card');
      if (!card) return;

      const jobId = el.textContent.trim();
      if (!jobId) return;

      startJobMove(card, 'current', jobId);
    }

    function handleNextJobClick(evt) {
      evt.stopPropagation();
      const el = evt.currentTarget;
      const card = el.closest('.sd-station-card');
      if (!card) return;

      const id = el.textContent.trim();
      const metaEl = card.querySelector('.sd-next-meta');
      const meta = metaEl ? metaEl.textContent.trim() : '';
      const label = meta ? `${id} ¬∑ ${meta}` : id;

      startJobMove(card, 'next', label);
    }

    function handleMoveTargetClick(evt) {
      evt.stopPropagation();
      const btn = evt.currentTarget;
      const card = btn.closest('.sd-station-card');
      if (!card) return;

      const target = btn.getAttribute('data-move-target'); // current | next | queue
      const rawLabel = card.dataset.pendingJobLabel || '';
      const label = rawLabel.trim();
      if (!label) {
        closeJobMoveForCard(card);
        return;
      }

      const source = card.dataset.pendingJobSource || 'queue';

      // Split "JOB-XXXX ¬∑ meta" into ID + meta
      const parts = label.split('¬∑');
      const jobId = parts[0].trim();
      const meta = parts.slice(1).join('¬∑').trim();

      const currentJobEl = card.querySelector('.sd-job-meta-row .sd-job-value'); // first job row
      const nextIdEl = card.querySelector('.sd-next-id');
      const nextMetaEl = card.querySelector('.sd-next-meta');
      const queueListEl = card.querySelector('.sd-queue-list');

      // If source was queue and we're promoting to current/next, remove that pill
      if (source === 'queue' && target !== 'queue') {
        const activePill = card.querySelector('.sd-queue-pill-active');
        if (activePill) activePill.remove();
      }

      if (target === 'current' && currentJobEl) {
        currentJobEl.textContent = jobId;
      } else if (target === 'next' && nextIdEl) {
        nextIdEl.textContent = jobId;
        if (nextMetaEl && meta) {
          nextMetaEl.textContent = meta;
        }
      } else if (target === 'queue' && queueListEl) {
        const pill = document.createElement('span');
        pill.className = 'sd-queue-pill';
        pill.textContent = label;
        pill.addEventListener('click', handleQueuePillClick);
        queueListEl.appendChild(pill);
      }

      closeJobMoveForCard(card);
    }

    // Attach listeners once on load
    document.querySelectorAll('.sd-queue-pill').forEach(pill => {
      pill.addEventListener('click', handleQueuePillClick);
    });

    // Make current job row clickable (first job row in each card)
    document.querySelectorAll('.sd-station-card').forEach(card => {
      const currentJobEl = card.querySelector('.sd-job-meta-row .sd-job-value');
      if (currentJobEl) {
        currentJobEl.style.cursor = 'pointer';
        currentJobEl.addEventListener('click', handleCurrentJobClick);
      }
    });

    // Make next job ID clickable
    document.querySelectorAll('.sd-next-id').forEach(el => {
      el.style.cursor = 'pointer';
      el.addEventListener('click', handleNextJobClick);
    });

    // Menu buttons
    document.querySelectorAll('.sd-job-move-menu [data-move-target]').forEach(btn => {
      btn.addEventListener('click', handleMoveTargetClick);
    });

    // Clicking on card background closes the move menu
    document.querySelectorAll('.sd-station-card').forEach(card => {
      card.addEventListener('click', () => {
        closeJobMoveForCard(card);
      });
    });

    // TODO: When you‚Äôre ready, replace the hard-coded station cards with
    // data-driven rendering from your Supabase queries. Keep the same
    // structure & data-* attributes (data-status, data-line, data-station)
    // so the filters and drawer logic continue to work.
  </script>
</body>
</html>
